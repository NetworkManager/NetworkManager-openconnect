#!/usr/bin/make -f

export DEB_BUILD_MAINT_OPTIONS = hardening=+all

include /usr/share/dpkg/architecture.mk

# Support older distros without GTK4
ifneq ("$(shell dpkg -l | grep libgtk-4-dev)","")
	GTK4=yes
else
	GTK4=no
endif

# Support older distros where libexec is not used by NM
ifeq ("$(shell dpkg --compare-versions $$(dpkg-query -W -f '$${Version}' libnm-dev) lt 1.44.2-3~ && echo yes)","yes")
	LIBEXEC=--libexecdir=/usr/lib/NetworkManager
else
	LIBEXEC=
endif

%:
	dh $@

override_dh_auto_configure:
	intltoolize --force
	dh_auto_configure -- \
		--with-gnome \
		--with-gtk4=$(GTK4) $(LIBEXEC) \
		--disable-static

execute_before_dh_install:
	find debian/tmp -name '*.la' -print -delete
ifeq ($(LIBEXEC),)
	install -D debian/tmp/usr/libexec/nm-openconnect-auth-dialog debian/network-manager-openconnect-gnome/usr/libexec/nm-openconnect-auth-dialog
	install -D debian/tmp/usr/libexec/nm-openconnect-service debian/network-manager-openconnect/usr/libexec/nm-openconnect-service
	install -D debian/tmp/usr/libexec/nm-openconnect-service-openconnect-helper debian/network-manager-openconnect/usr/libexec/nm-openconnect-service-openconnect-helper
else
	install -D debian/tmp/usr/lib/NetworkManager/nm-openconnect-auth-dialog debian/network-manager-openconnect-gnome/usr/lib/NetworkManager/nm-openconnect-auth-dialog
	install -D debian/tmp/usr/lib/NetworkManager/nm-openconnect-service debian/network-manager-openconnect/usr/lib/NetworkManager/nm-openconnect-service
	install -D debian/tmp/usr/lib/NetworkManager/nm-openconnect-service-openconnect-helper debian/network-manager-openconnect/usr/lib/NetworkManager/nm-openconnect-service-openconnect-helper
endif

override_dh_makeshlibs:
	dh_makeshlibs -X/usr/lib/$(DEB_HOST_MULTIARCH)/NetworkManager/
